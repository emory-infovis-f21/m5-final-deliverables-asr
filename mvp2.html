<!-- THIS SYSTEM WAS DESIGNED AND DEVELOPED BY RANDY TRUONG
FOR CS 485 PROJECT, EMORY UNIVERSITY 2021-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>CS 485 Project</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <link rel="stylesheet" href="style.css">

    <script src="https://unpkg.com/d3-tip@0.9.1/dist/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>

  </head>
  <body>
    <h1>Visualizing Invisible Human Byproducts: Air Pollution</h1>
    <!--
    <div id="container">
      <span id="date" style='margin: 20px;'></span>
      <input id="slider" type="range" min="0" step="1" value="0">
      
    </div>
    -->

    <script>

      Promise.all([
	    d3.csv('assets/data/2016-20CO_clean_data_keys.csv'),
      d3.json('https://gist.githubusercontent.com/mheydt/29eec003a4c0af362d7a/raw/d27d143bd75626647108fc514d8697e0814bf74b/us-states.json'),
	    ]).then(ready);


      // Load the data
      function ready(data) {
        
        console.log('data');
        const co_data = data[0];
        console.log(co_data);

        console.log('map');
        const map_features = data[1];
        console.log(map_features);

        // Number of dates
        let unique_keys = [...new Set(co_data.map(d => d["Date_Keys"]))]
        let date_string = [...new Set(co_data.map(d => d["Date"]))]
        console.log("unique_keys");
        console.log(unique_keys);
        console.log(date_string);

        const numMonths = unique_keys.length-1;
        console.log(numMonths);

        const startMonth = +unique_keys[0];
        console.log(unique_keys);
        console.log(startMonth);

        const valRange = [-50, 0, 15, 30];
        const color = "DAILY_AQI_VALUE";
        

        // List of states
        const states = ["Alaska","Alabama","Arkansas","Arizona","California","Colorado","Connecticut",
        "District of Columbia","Delaware","Florida","Georgia","Hawaii","Iowa","Idaho","Illinois","Indiana",
        "Kansas","Kentucky","Louisiana","Massachusetts","Maryland","Maine","Michigan","Minnesota","Missouri",
        "Mississippi","Montana","North Carolina","North Dakota","Nebraska","New Hampshire","New Jersey",
        "New Mexico","Nevada","New York","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina",
        "South Dakota","Tennessee","Texas","Utah","Virginia","Vermont","Washington","Wisconsin","West Virginia","Wyoming"];
        
        // Set width and heights
        let w = 864; 
		    let h = 486;
        let svg = d3.select("body")
		        .append("svg")
		        .attr("width", w)
		        .attr("height", h);

        svg.append("rect")
			      .attr("width", "100%")
			      .attr("height", "100%")
			      .attr("fill", "#f3f3f3");

        svg.append("svg:foreignObject")
            .attr("width", 60)
            .attr("height", 20)
            .attr("y", `${h-50}px`)
            .attr("x", `${w-75}px`)
            .append("xhtml:span")
	          .attr("id", "date");

        svg.append("svg:foreignObject")
            .attr("width", 200)
            .attr("height", 30)
            .attr("y", `${h-30}px`)
            .attr("x", `${w-180}px`)
            .append("xhtml:div")
            .attr("id", "container")
            .append("xhtml:input")
            .attr("id", "slider")
            .attr("type", "range")
            .attr("min", "0")
            .attr("step", "1")
            .attr("value", "0")
	  


        // Link slider to updating key
        d3.select("#slider")
        .attr("max", numMonths)
        .on("input", function() {
          var key = +startMonth + 1*this.value;
          console.log(key);
          update(key);
        });

        const colorMap = d3.scaleLinear()
        .domain(valRange)
        .range(["#bcd4b5", "#679857", "#636363"]);
        
        
        const tool_tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-8, 0]);
        

        render(map_features);
        update(startMonth);

        // Helper function which, given the entire stats data structure, extracts the requested rate for the requested state
        function getStateMetrics(stats, state_name) {
            for (var i = 0; i < stats.length; i++) {
                if (stats[i].State_Fixed == state_name) {
                    return stats[i];
                }
            }
        }

        // Renders the map once, don't fill it in yet
        function render(map) {
            const projection = d3.geoAlbersUsa()
            .translate([w / 2, h / 2]) // translate to center of screen
            .scale([900]); // scale things down so see entire US

            // Define path generator
            const path = d3.geoPath().projection(projection);

            svg.call(tool_tip);

            svg.append("g")
            .attr("class", "states")
            .selectAll("path")
            // NOTE: The filter here is only to make the example simpler
            .data(map.features.filter(d => states.includes(d.properties.name)))
            .enter().append("path")
            .on("mouseover", tool_tip.show)
            .on("mouseout", tool_tip.hide)
            .on("mousedown", function(event, d) {
              console.log("This was clicked!");
              console.log(event);
              //d3.selectAll('.statesView').remove()
              buildState(1, 2);
            })
            .on("mouseup", function(event, d) {
              d3.selectAll('.statesView').remove();
            })
            .attr("d", path);
        }

        function buildState(state, date) {
          let svg2 = d3.select("body")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h/3)
                    .attr("class", "statesView");
          svg2.append("rect")
              .attr("width", "100%")
              .attr("height", "100%")
              .attr("fill", "#f3f3f3");
        }        

        // Update the map with the data for the selected date
        function update(date) {
            const stats = co_data.filter(function(row) {
            return +row.Date_Keys === +date;
            });

            d3.select("#date").text(date_string[+date]);

            tool_tip
            .html(function(d, i) {
                //const stateMetrics = getStateMetrics(stats, d.properties.name);
                //console.log(stats);
                const stateMetrics = getStateMetrics(stats, d.properties.name);
                let html;

                if (stateMetrics) {
                    html = "<table>" +
                    "<tr><th>Date:</th><td>" + date_string[+date] + "</td></tr>" +
                    "<tr><th>State:</th><td>" + stateMetrics.State_Fixed + "</td></tr>" +
                    "<tr><th>Mean Daily AQI: </th><td>" + stateMetrics.DAILY_AQI_VALUE + "</td></tr>" +
                    "<tr><th>CO Concentration: </th><td>" + stateMetrics.DM8CO_Concentration + "</td></tr>" +
                    "</table>";
                } else {
                    html = "<table>" +
                    "<tr><th>Date:</th><td>" + date_string[+date] + "</td></tr>" +
                    "<tr><th>State:</th><td>" + stateMetrics.State_Fixed + "</td></tr>" +
                    "<tr><th>Mean Daily AQI: </th><td>" + "NO DATA AVAILABLE" + "</td></tr>" +
                    "<tr><th>CO Concentration: </th><td>" + "NO DATA AVAILABLE" + "</td></tr>" +
                    "</table>";

                }
                return html;
            });

            svg.selectAll("path")
            .attr("fill", function(d) {
                const rate = getStateMetrics(stats, d.properties.name)[color];
                
                if (rate == undefined) {
                    rate = 15;
                }
                return colorMap(rate);
            });
        }


      }

      
    </script>


  </body>
</html>