<!-- THIS SYSTEM WAS DESIGNED AND DEVELOPED BY RANDY TRUONG
FOR CS 485 PROJECT, EMORY UNIVERSITY 2021-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>CS 485 Project</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <link rel="stylesheet" href="style.css">

    <script src="https://unpkg.com/d3-tip@0.9.1/dist/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>

  </head>
  <body>
    <h1>Visualizing Invisible Human Byproducts: Air Pollution</h1>
    <!--
    <div id="container">
      <span id="date" style='margin: 20px;'></span>
      <input id="slider" type="range" min="0" step="1" value="0">
      
    </div>
    -->

    <script>

      Promise.all([
	    d3.csv('assets/data/2016-20CO_clean_data_keys.csv'),
      d3.json('https://gist.githubusercontent.com/mheydt/29eec003a4c0af362d7a/raw/d27d143bd75626647108fc514d8697e0814bf74b/us-states.json'),
	    ]).then(ready);


      // Load the data
      function ready(data) {
        
        console.log('data');
        const co_data = data[0];
        console.log(co_data);

        console.log('map');
        const map_features = data[1];
        console.log(map_features);

        // Number of dates
        let unique_keys = [...new Set(co_data.map(d => d["Date_Keys"]))]
        let date_string = [...new Set(co_data.map(d => d["Date"]))]
        console.log("unique_keys");
        console.log(unique_keys);
        console.log(date_string);

        const numMonths = unique_keys.length-1;
        console.log(numMonths);

        const startMonth = +unique_keys[0];
        console.log(unique_keys);
        console.log(startMonth);

        const valRange = [-50, 0, 15, 30];
        const color = "DAILY_AQI_VALUE";
        

        // List of states
        const states = ["Alaska","Alabama","Arkansas","Arizona","California","Colorado","Connecticut",
        "District of Columbia","Delaware","Florida","Georgia","Hawaii","Iowa","Idaho","Illinois","Indiana",
        "Kansas","Kentucky","Louisiana","Massachusetts","Maryland","Maine","Michigan","Minnesota","Missouri",
        "Mississippi","Montana","North Carolina","North Dakota","Nebraska","New Hampshire","New Jersey",
        "New Mexico","Nevada","New York","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina",
        "South Dakota","Tennessee","Texas","Utah","Virginia","Vermont","Washington","Wisconsin","West Virginia","Wyoming"];
        
        // Set width and heights
        let w = 864; 
		    let h = 486;
        let svg = d3.select("body")
            .attr("style", "text-align: center;")
		        .append("svg")
		        .attr("width", w)
		        .attr("height", h);

        svg.append("rect")
			      .attr("width", "100%")
			      .attr("height", "100%")
			      .attr("fill", "#f3f3f3");

        // The slider
        svg.append("svg:foreignObject")
            .attr("width", 200)
            .attr("height", 30)
            .attr("y", `${h-30}px`)
            .attr("x", `${w-180}px`)
            .append("xhtml:div")
            .attr("id", "container")
            .append("xhtml:input")
            .attr("id", "slider")
            .attr("type", "range")
            .attr("min", "0")
            .attr("step", "1")
            .attr("value", "0")

        // The date
        svg.append("svg:foreignObject")
            .attr("width", 60)
            .attr("height", 20)
            .attr("y", `${h-50}px`)
            .attr("x", `${w-75}px`)
            .append("xhtml:span")
	          .attr("id", "date");

        let right_column = d3.select("body")
		        .append("svg")
		        .attr("width", w/3)
		        .attr("height", h)
            .attr("style", "margin-left: 5px;");

        let information = right_column
		        .append("svg")
		        .attr("width", w/3)
		        .attr("height", h/2 - 2.5)
            .attr("style", "margin-bottom: 2.5px;");

        information.append("rect")
			      .attr("width", "100%")
			      .attr("height", "100%")
			      .attr("fill", "#f3f3f3");

        information.append("svg:foreignObject")
            .attr("width", w/3)
            .attr("height", 20)
            .attr("y", 10)
            .append("xhtml:span")
            .attr("id", `info-date`);

        information.append("svg:foreignObject")
            .attr("width", w/3)
            .attr("height", 20)
            .attr("y", 40)
            .append("xhtml:span")
            .attr("id", `info-state`);
        
        information.append("svg:foreignObject")
            .attr("width", w/3)
            .attr("height", 20)
            .attr("y", 70)
            .append("xhtml:span")
            .attr("id", `info-aqi`);

        information.append("svg:foreignObject")
            .attr("width", w/3)
            .attr("height", 20)
            .attr("y", 100)
            .append("xhtml:span")
            .attr("id", `info-co`);

        

        let breakdown = right_column
		        .append("svg")
		        .attr("width", w/3)
		        .attr("height", h/2 - 2.5)
            .attr("y", h/2 + 2.5)
            .attr("style", "margin-top: 2.5px;");

        breakdown.append("rect")
			      .attr("width", "100%")
			      .attr("height", "100%")
			      .attr("fill", "#f3f3f3");
        
        let bottom_panel = d3.select("body")
            .append("svg")
		        .attr("width", w)
		        .attr("height", h/3);

        bottom_panel.append("rect")
          .attr("width", "100%")
          .attr("height", "100%")
          .attr("fill", "#f3f3f3");
        
        let citations = d3.select("body")
            .append("svg")
		        .attr("width", w/3)
		        .attr("height", h/3)
            .attr("style", "margin-left: 5px;");
        
        citations.append("rect")
          .attr("width", "100%")
          .attr("height", "100%")
          .attr("fill", "#f3f3f3");
	  


        // Link slider to updating key
        d3.select("#slider")
        .attr("max", numMonths)
        .on("input", function() {
          var key = +startMonth + 1*this.value;
          console.log(key);
          update(key);
        });

        const colorMap = d3.scaleLinear()
        .domain(valRange)
        .range(["#FFFFFF", "#a7c9d2", "#111111", "#679857"]);
        
        
        const tool_tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-8, 0]);

        render(map_features);
        update(startMonth);

        // Helper function which, given the entire stats data structure, extracts the requested rate for the requested state
        function getStateMetrics(stats, state_name) {
            for (var i = 0; i < stats.length; i++) {
                if (stats[i].State_Fixed == state_name) {
                  //console.log(stats[i]);
                    return stats[i];
                }
            }
        }

        // Renders the map once, don't fill it in yet
        function render(map) {
            const projection = d3.geoAlbersUsa()
            .translate([w / 2, h / 2]) // translate to center of screen
            .scale([900]); // scale things down so see entire US

            // Define path generator
            const path = d3.geoPath().projection(projection);

            svg.call(tool_tip);
            
            svg.append("g")
            .attr("class", "states")
            .selectAll("path")
            // NOTE: The filter here is only to make the example simpler
            .data(map.features.filter(d => states.includes(d.properties.name)))
            .enter().append("path")
            //.on("mouseover", tool_tip.show)
            //.on("mouseout", tool_tip.hide)
            .attr("d", path);
        }

        // Display state history
        function buildState(state, data) {
          /*
          let svg2 = d3.select("body")
            .append("svg")
		        .attr("width", w)
		        .attr("height", h/3);

          svg2.append("rect")
          .attr("width", "100%")
          .attr("height", "100%")
          .attr("fill", "#f3f3f3");
          */

          const passedState = state.State_Fixed;
          const passedDate = state.Date;
          
          const specific_data = co_data.filter(function(row) {
            return row.State_Fixed === passedState && row.Date.slice(-2) === passedDate.slice(-2)
          });

          console.log(specific_data);
          console.log(specific_data.length);

          for (var i = 0; i < specific_data.length; i++) {

            let history = bottom_panel
		        .append("svg")
            .attr("y", h/6 * 1/2)
		        .attr("width", w/6)
            .attr("class", "state-hist")
            .attr("x", i*w/5)
		        .attr("height", h/6);

            history.append("rect")
              .attr("width", "100%")
              .attr("height", "100%")
              .attr("fill", "#f3f3f3");

            const projection = d3.geoAlbersUsa()
              .translate([w / 12, h / 12])
              .scale([1]);

            const path = d3.geoPath().projection(projection);

            var feature = [data];
            console.log(feature);
            projection.fitSize([w/6, h/6], feature[0]);

            history.append("g")
                .attr("class", "states")
                .selectAll("path")
                .data(feature)
                .enter().append("path")
                .attr("d", path)
                .attr("fill", function(d) {
                  const rate = specific_data[i].DAILY_AQI_VALUE
                  console.log(rate)
                  
                  if (rate == undefined) {
                        rate = -50;
                  }
                  return colorMap(rate);

                });

            let caption = bottom_panel.append("svg:foreignObject")
                .attr("y", h/4 + 10)
                .attr("width", 60)
                .attr("class", "state-hist")
                .attr("x", i*w/5 + 60)
                .attr("height", 20)
                .append("xhtml:span")
                .attr("id", `date-${i}`);;
            
            d3.select(`#date-${i}`).text(specific_data[i].Date.slice(0,4));

          } 

        }        

        // Update the map with the data for the selected date
        function update(date) {
            const stats = co_data.filter(function(row) {
            return +row.Date_Keys === +date;
            });

            d3.select("#date").text(date_string[+date]);

            tool_tip
            .html(function(d, i) {
                //const stateMetrics = getStateMetrics(stats, d.properties.name);
                //console.log(stats);
                const stateMetrics = getStateMetrics(stats, d.properties.name);
                let html;

                if (stateMetrics) {
                    html = "<table>" +
                    "<tr><th>Date:</th><td>" + date_string[+date] + "</td></tr>" +
                    "<tr><th>State:</th><td>" + stateMetrics.State_Fixed + "</td></tr>" +
                    "<tr><th>Mean Daily AQI: </th><td>" + stateMetrics.DAILY_AQI_VALUE + "</td></tr>" +
                    "<tr><th>CO Concentration: </th><td>" + stateMetrics.DM8CO_Concentration + "</td></tr>" +
                    "</table>";
                } else {
                    html = "<table>" +
                    "<tr><th>Date:</th><td>" + date_string[+date] + "</td></tr>" +
                    "<tr><th>State:</th><td>" + stateMetrics.State_Fixed + "</td></tr>" +
                    "<tr><th>Mean Daily AQI: </th><td>" + "NO DATA AVAILABLE" + "</td></tr>" +
                    "<tr><th>CO Concentration: </th><td>" + "NO DATA AVAILABLE" + "</td></tr>" +
                    "</table>";

                }
                return html;
            });


             

            svg.selectAll("path")
            .attr("fill", function(d) {
                const rate = getStateMetrics(stats, d.properties.name)[color];
                
                if (rate == undefined) {
                    rate = -50;
                }
                return colorMap(rate);
            })
            .on("mouseover", function(d) {
              const stateMetrics = getStateMetrics(stats, d.properties.name);

              d3.select("#info-date").text("Date: " + stateMetrics.Date);
              d3.select("#info-state").text("State: " + stateMetrics.State_Fixed);
              d3.select("#info-aqi").text("Daily AQI (Mean): " + (+stateMetrics.DAILY_AQI_VALUE).toFixed(3));
              d3.select("#info-co").text("Daily Max CO Conc. (Mean): " + (+stateMetrics.DM8CO_Concentration).toFixed(3));

            })
            .on("mouseout", function(d) {
              d3.select("#info-date").text("");
              d3.select("#info-state").text("");
              d3.select("#info-aqi").text("");
              d3.select("#info-co").text("");
            })
            .on("mousedown", function(event, d) {
              d3.select(this)
                .style("fill", "#efd06c");
                /*
                console.log(this);
                console.log(this.__data__);
                console.log(stats);
                */
                state_data = getStateMetrics(stats, this.__data__.properties.name);
                console.log(state_data);
                
                buildState(state_data, this.__data__);

            })
            .on("mouseup", function(event, d) {
              d3.select(this)
                .style("fill", function(d) {
                  const rate = getStateMetrics(stats, d.properties.name)[color];
                
                  if (rate == undefined) {
                      rate = 15;
                  }
                  return colorMap(rate);

                });
              d3.selectAll('.state-hist').remove()
            });
        }


      }

      
    </script>


  </body>
</html>